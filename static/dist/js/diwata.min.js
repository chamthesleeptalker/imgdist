function renderVis(a){data=[];for(var b=start_date.clone();end_date.diff(b)>=0;){var c={date:b.clone().toDate(),value:getvalue(b.toDate())};data.push(c),b=b.add(1,"d").startOf()}x.domain([start_date,end_date]).rangeRound([0,vis.width]),y.domain([0,1]).rangeRound([0,vis.height]),weeks=d3.nest().key(function(a){return d3.time.monday(a.date)}).entries(data);var d=svg.select("g.bars").selectAll("rect.bar").data(data,function(a){return a.date});d.transition().attr("x",function(a,b){return x(a.date)+.5}).attr("y",function(a,b){return vis.height-y(a.value)+.5}).attr("height",function(a,b){return y(a.value)}),d.enter().append("rect").attr("class","bar").attr("x",function(b,c){return x(d3.time.day.offset(b.date,a*vis.navjump))+.5}).attr("y",function(a,b){return vis.height-y(a.value)+.5}).attr("width",function(a,b){return vis.barWidth}).attr("height",function(a,b){return y(a.value)}).attr("opacity",0).transition().attr("x",function(a,b){return x(a.date)+.5}).attr("opacity",1),d.exit().transition().attr("opacity",0).attr("x",function(a,b){return x(a.date)+.5}).remove();var e=svg.select("g.weekdays").selectAll("text.wday").data(data,function(a){return a.date});e.transition().attr("x",function(a,b){return x(a.date)+vis.barWidth/2}),e.enter().append("text").attr("class","wday").attr("x",function(b,c){return x(d3.time.day.offset(b.date,a*vis.navjump))+vis.barWidth/2}).attr("y",function(a,b){return vis.height+10}).attr("opacity",0).style("font-family","sans-serif").style("font-size",9).style("text-anchor","middle").style("stroke",function(a){return["0","6"].indexOf(wday(a.date))>=0?"red":"black"}).style("fill",function(a){return["0","6"].indexOf(wday(a.date))>=0?"red":"black"}).style("stroke-width",.3).style("shape-rendering","crispEdges").text(function(a){return weekdays[wday(a.date)]}).transition().attr("x",function(a,b){return x(a.date)+vis.barWidth/2}).attr("opacity",1),e.exit().transition().attr("x",function(a,b){return x(a.date)+vis.barWidth/2}).attr("opacity",0).remove();var f=svg.select("g.weeks").selectAll("g.week").data(weeks,function(a){return a.key}),g=f.enter().insert("g").attr("class","week").attr("opacity",0).attr("transform",function(b){return"translate("+x(d3.time.day.offset(b.values[0].date,a*vis.navjump))+","+vis.height+")"});g.transition().attr("transform",function(a){return"translate("+x(a.values[0].date)+","+vis.height+")"}).attr("opacity",1),g.append("rect").attr("height",14).attr("width",function(a,b){return vis.barWidth*a.values.length}).attr("fill","transparent").style("shape-rendering","crispEdges").style("stroke","#789").style("stroke-width",1);var h=function(a,b){return a.values.length>=4?weekdisp(a.values[0].date):""};g.append("text").attr("x",3).attr("y",11).style("text-anchor","left").style("font-family","sans-serif").style("font-size",10).text(h),wgrp_trans=f.transition().attr("transform",function(a){return"translate("+x(a.values[0].date)+","+vis.height+")"}).attr("opacity",1),wgrp_trans.select("rect").attr("width",function(a,b){return vis.barWidth*a.values.length}),wgrp_trans.select("text").text(h),f.exit().transition().attr("opacity",0).attr("transform",function(a){return"translate("+x(a.values[0].date)+","+vis.height+")"}),brush&&brushmove(),navNext.transition().attr("opacity",end_date.unix()==moment().endOf().unix()?0:.4).attr("display",end_date.unix()==moment().endOf().unix()?"none":"block")}function brushstart(){}function brushmove(a){d3.select(this.parentNode);if(a)selection=a,b=a,selection[0].getTime()>selection[1]&&(selection=null),b=b.map(d3.time.day.round),brushg.call(brush.extent(b.map(d3.time.day.round))).selectAll(".resize").style("display",selection&&selection[0].getTime()<=selection[1].getTime()?null:"none"),updateSelectionCaption(),selectionChanged(selection);else{var b=brush.extent();selection=[d3.time.day.round(b[0]),d3.time.day.offset(d3.time.day.round(b[1]),-1)],selection[0].getTime()>selection[1]&&(selection=null),b=b.map(d3.time.day.round),brushg.call(brush.extent(b.map(d3.time.day.round))).selectAll(".resize").style("display",selection&&selection[0].getTime()<=selection[1].getTime()?null:"none"),updateSelectionCaption(),selectionChanged(selection)}}function brushend(){}function updateSelectionCaption(){selection_caption.attr("display",function(){return selection&&selection[0].getTime()<=selection[1].getTime()?null:"none"}).attr("transform",function(){return selection&&"translate("+x(selection[0])+",0)"}).select("text").text(selection&&dateformat(selection[0])+" ▸ "+dateformat(selection[1]))}function resizePath(a){var b=+("e"==a),c=b?1:-1,d=2*vis.height/3,e=(vis.height-d)/2;return"M"+.5*c+","+e+"A6,6 0 0 "+b+" "+6.5*c+","+(e+6)+"V"+(e+d-6)+"A6,6 0 0 "+b+" "+.5*c+","+(e+d)+"ZM"+2.5*c+","+(e+8)+"V"+(e+d-8)+"M"+4.5*c+","+(e+8)+"V"+(e+d-8)}function getvalue(a){if(datevaluemap.has(a))return datevaluemap.get(a);var b=Math.random();return datevaluemap.set(a,b),b}function selectionChanged(a){var b=a?fil_dateformat(a[0])+" - "+fil_dateformat(a[1]):"";$("#currentDateFil").html(b)}function executeFilters(){var a=areaSelect.getBounds(),b=a._southWest,c=a._northEast,d=cloudSlider;void 0==cloudSlider.data().from?($("#currentCloudFil").html("0 - 100%"),d.data().from=0,d.data().to=100):$("#currentCloudFil").html(d.data().from+" - "+d.data().to+"%");var e={sat:satTray.toString(),payload:imageTray.toString(),start:dateformatfull(selection[0]),end:dateformatfull(selection[1]),cloud:"["+d.data().from+","+d.data().to+"]",bbox:JSON.stringify([b.lng,b.lat,c.lng,c.lat])};$.get(main_url,e,function(a){updateMapMarkers(a),updateCards(a),updateOnImageCartCards(imageCartEntries)})}function updateMapMarkers(a){image_markers&&image_markers.clearLayers(),image_markers.addData(a)}function zoomToScene(a){if(a.length<2){var b=L.polygon(a[0]),c=[b.getBounds().getCenter().lng,b.getBounds().getCenter().lat];map.setView(c,8)}else{var d=L.circleMarker([a[1],a[0]]),e=[d.getLatLng().lat,d.getLatLng().lng];map.setView(e,8)}}function addImageToCart(a,b){var c={scene_name:a,image_url:b};imageCartEntries.push(c);var d=imageCartEntries.length;$("#imageCartCount").text(d),$("#imagetocart_"+a).text("Remove from Cart"),$("#imagetocart_"+a).removeClass("btn-info"),$("#imagetocart_"+a).addClass("btn-warning"),$("#imagetocart_"+a).attr("onclick",'removeImageFromCart("'+a+'","'+b+'")');var e=$("#imagecart-template").html();Mustache.parse(e),rendered_imageCartEntries=Mustache.to_html(e,{imageCartEntries:imageCartEntries}),$("#imageCartList").html(rendered_imageCartEntries)}function removeImageFromCart(a,b){var c={scene_name:a,image_url:b};removedCartEntries.push(c);var d=_.findIndex(imageCartEntries,c),e=(_.pullAt(imageCartEntries,d),imageCartEntries.length);$("#imageCartCount").text(e),$("#imagetocart_"+a).text("Add to Cart"),$("#imagetocart_"+a).removeClass("btn-warning"),$("#imagetocart_"+a).addClass("btn-info"),$("#imagetocart_"+a).attr("onclick",'addImageToCart("'+a+'","'+b+'")');var f=$("#imagecart-template").html();Mustache.parse(f),rendered_imageCartEntries=Mustache.to_html(f,{imageCartEntries:imageCartEntries}),$("#imageCartList").html(rendered_imageCartEntries)}function updateCards(a){var b=$("#card-template").html();Mustache.parse(b),data_array=a.features;var c=[];for(var d in data_array){var e={image_url:data_array[d].properties.links.thumbnail_url,payload:data_array[d].properties.payload,sat_id:data_array[d].properties.sat.sat_id,published:data_array[d].properties.published,receiving_station:data_array[d].properties.receiving_station,scene_id:data_array[d].properties.scene_id,cloud_cover:data_array[d].properties.cloud_cover,zoomtoscene:JSON.stringify(data_array[d].geometry.coordinates)};c.push(e)}rendered_cards=Mustache.to_html(b,{cards:c}),$("#imageCards").html(rendered_cards)}function updateOnImageCartCards(a){for(var b in a)onClickRemoveFromCart(a[b])}function onClickRemoveFromCart(a){$("#imagetocart_"+a.scene_name).text("Remove from Cart"),$("#imagetocart_"+a.scene_name).removeClass("btn-info"),$("#imagetocart_"+a.scene_name).addClass("btn-warning"),$("#imagetocart_"+a.scene_name).attr("onclick",'removeImageFromCart("'+a.scene_name+'","'+a.image_url+'")')}function isInArray(a,b){return-1!==b.indexOf(a)}function downloadAllImages(){for(var a in imageCartEntries){var b=window.open(imageCartEntries[a].image_url,"_blank");b.focus()}}function init(){$.material.init(),$("#datefilterstart").datetimepicker({format:"YYYY-MM-DD",defaultDate:"2016-01-01"}),$("#datefilterend").datetimepicker({format:"YYYY-MM-DD",defaultDate:new Date}),cloudSlider.ionRangeSlider({type:"double",min:0,max:100,from:0,to:100,grid:!0})}function init_map(){var a="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",b='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',c=new L.TileLayer(a,{minZoom:2,maxZoom:12,attribution:b});map.setView(new L.LatLng(11.5,121.8),6),map.addLayer(c);var d,e;d=$("#map_section").width(),e=$("#map_section").height(),areaSelect=L.areaSelect({width:d-100,height:e-100,keepAspectRatio:!1}),areaSelect.addTo(map),areaSelect.on("change",function(){bounds=areaSelect.getBounds(),executeFilters(bounds)});var f={radius:8,fillColor:"#1c3166",color:"#000",weight:1,opacity:1,fillOpacity:.4},g={color:"#1C0021",weight:3,opacity:1,fillColor:"#1C0021",fillOpacity:.3},h={closeOnClick:!0,className:"popup",closeButton:!1};image_markers=L.geoJson(!1,{style:function(a){return"Point"==a.geometry.type?f:g},pointToLayer:function(a,b){return L.circleMarker(b,f)},onEachFeature:function(a,b){var c=new L.popup(h),d="<h4>SCENE INFO</h4>";d+="<p><b>Acquisition Date:</b> "+a.properties.published+"</p>",d+="<p><b>Cloud Cover:</b> "+a.properties.cloud_cover+"</p>",d+="<p><b>Receiving Station:</b> "+a.properties.receiving_station+"</p>",d+="<p><b>Satellite:</b> "+a.properties.sat.sat_id+"</p>",d+="<p><b>Scene Name:</b> "+a.properties.scene_id+"</p>",d+="<p><b>Sensor:</b> "+a.properties.payload+"</p>",c.setContent(d),b.bindPopup(c)}}),image_markers.addTo(map)}var vis={width:800,height:90,margin:{top:20,right:30,bottom:20,left:30},numdays:365,navjump:5,barWidth:5,navWidth:20};vis.barWidth=Math.floor(vis.width/(vis.numdays+1)),vis.width=vis.barWidth*(vis.numdays+1);var weekdays=["S","M","T","W","T","F","S"],wday=d3.time.format("%w"),dateformat=d3.time.format("%m-%d"),dateformatfull=d3.time.format("%Y-%m-%d"),fil_dateformat=d3.time.format("%B %d, %Y "),weekdisp=d3.time.format("%b %e"),end_date=moment().endOf("year"),start_date=end_date.clone().subtract(vis.numdays,"d").startOf(),datevaluemap=d3.map(),data,weeks,brush,brushg,selection,x=d3.time.scale(),y=d3.scale.linear();selection=[start_date._d,end_date._d],$("#currentDateFil").html(fil_dateformat(selection[0])+" - "+fil_dateformat(selection[1]));var svg=d3.select("#chart").append("svg").attr("width",vis.margin.left+vis.width+vis.margin.right).attr("height",vis.margin.top+vis.height+vis.margin.bottom).append("g").attr("transform","translate("+vis.margin.left+","+vis.margin.top+")");svg.append("rect").attr("class","background").attr("width",vis.width).attr("height",vis.height).attr("fill","#f4f4f4").style("shape-rendering","crispEdges").style("stroke","#cccccc");var navPrev=svg.append("g").attr("class","nav-prev").attr("transform","translate("+(-vis.navWidth-3.5)+",0.5)").on("mouseover",function(){d3.select(this).transition().attr("opacity",1)}).on("mouseout",function(){d3.select(this).transition().duration(100).attr("opacity",.4)}).on("click",function(){start_date=start_date.subtract(vis.navjump,"d").startOf(),end_date=end_date.clone().subtract(vis.navjump,"d").endOf(),renderVis(-1);dateformatfull(selection[1]),dateformatfull(end_date._d);selection[1]=end_date._d,brushmove(selection)}).attr("opacity",.4).style("cursor","pointer");navPrev.append("rect").attr("height",vis.height+26-12.5).attr("width",vis.navWidth).attr("rx",2).attr("ry",2).style("stroke","#777").style("stroke-width",1).style("fill","transparent"),navPrev.append("path").style("fill","#000").attr("d",function(){var a=35;return"M"+(Math.round(.75*vis.navWidth)+.5)+","+a+"V"+(vis.height+26-a)+"L"+Math.round(.25*vis.navWidth)+","+Math.round((vis.height+26)/2)+"Z"});var navNext=svg.append("g").attr("class","nav-next").attr("transform","translate("+(vis.width+3.5)+",0.5)").on("mouseover",function(){d3.select(this).transition().attr("opacity",1)}).on("mouseout",function(){d3.select(this).transition().duration(100).attr("opacity",.4)}).on("click",function(){end_date.add(vis.navjump,"d"),end_date=end_date.endOf().unix()>moment().endOf().unix()?moment().endOf():end_date,start_date=end_date.clone().subtract(vis.numdays,"d").startOf(),renderVis(1);dateformatfull(selection[0]),dateformatfull(start_date._d);selection[0]=start_date._d,brushmove(selection)}).attr("opacity",.4).style("cursor","pointer");navNext.append("rect").attr("height",vis.height+26-12.5).attr("width",vis.navWidth).attr("rx",2).attr("ry",2).style("stroke","#777").style("stroke-width",1).style("fill","transparent"),navNext.append("path").style("fill","#000").attr("d",function(){var a=35;return"M"+(Math.round(.25*vis.navWidth)+.5)+","+a+"V"+(vis.height+26-a)+"L"+Math.round(.75*vis.navWidth)+","+Math.round((vis.height+26)/2)+"Z"}),svg.append("g").attr("class","bars"),svg.append("g").attr("class","weeks"),renderVis(-1),brush=d3.svg.brush().x(x).on("brushstart",brushstart).on("brush",brushmove).on("brush",executeFilters).on("brushend",brushend),brushg=svg.append("g").attr("class","brush").call(brush),brushg.selectAll("rect").attr("height",vis.height),brushg.selectAll(".resize").append("path").attr("d",resizePath);var selection_caption=svg.append("g").attr("class","selection_caption").attr("display","none");selection_caption.append("rect").attr("height",14).attr("width",75).attr("fill","#fff").style("stroke","black").style("opacity",.8).style("stroke-width",.3).attr("rx",4).attr("ry",4),selection_caption.append("text").attr("x",2).attr("y",11).style("font-size",10).style("font-family","sans-serif");var imageCartEntries=[],removedCartEntries=[],main_url="http://diwataapi-lkpanganiban.rhcloud.com/api/v2/scene/multi/",cloudSlider=$("#cloud_slide"),map=L.map("map"),imageTray=["hpt","mfc","wfc","smi","landsat8"],satTray=["diwata-1","landsat-8"];$(function(){init(),init_map(),$("#satelliteFilter, #sensorFilter").on("change",function(){executeFilters()}),$(".imageFilter").on("change",function(){imageTray=[],$.each($("input[name='imgFilter']:checked"),function(){imageTray.push($(this).val())});var a=isInArray("landsat8",imageTray);satTray=a===!0&&imageTray.length>=2?["diwata-1","landsat-8"]:a===!1&&imageTray.length>=1?["diwata-1"]:["landsat-8"],executeFilters()}),cloudSlider.on("change",function(){executeFilters()}),executeFilters()}),$("#cloud_fil").on("click",function(){$("#cloudFilterContainer").slideToggle("fast"),$("#dateFilterContainer").css("display","none"),$("#imageFilterContainer").css("display","none")}),$("#date_fil").on("click",function(){$("#dateFilterContainer").slideToggle("fast"),$("#cloudFilterContainer").css("display","none"),$("#imageFilterContainer").css("display","none")}),$("#image_fil").on("click",function(){$("#imageFilterContainer").slideToggle("fast"),$("#cloudFilterContainer").css("display","none"),$("#dateFilterContainer").css("display","none")});