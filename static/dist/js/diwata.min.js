function brushed(){histogramToCalendar(brush.extent())}function updateData(a){if(0==a.length);else{data=getAllDates(a),start_date=data[0].date;var b=Math.floor(data.length/2),c=data.length;end_date=data[data.length-1].date,x.domain([d3.time.day.offset(new Date(start_date),-10),d3.time.day.offset(new Date(end_date),10)]),y.domain([0,d3.max(data,function(a){return a.f})]),c>10?xAxis.ticks(d3.time.month,1):xAxis.ticks(d3.time.days,b),svg.select(".x.axis").transition().duration(500).call(xAxis),svg.select(".y.axis").transition().duration(500).call(yAxis),brush.extent([new Date(start_date),new Date(end_date)]),svg.select(".brush").call(brush);var d=svg.selectAll(".bar").data(data);d.exit().transition().duration(500).attr("y",y(0)).attr("height",height-y(0)).style("fill-opacity",1e-6).remove(),d.enter().append("rect").attr("class","bar"),d.transition().duration(500).attr("width",function(a){return 5}).attr("transform",function(a){var b=x(new Date(a.date))-.5*(.5*width/data.length);return"translate("+b+","+y(a.f)+")"}).attr("height",function(a){return height-y(a.f)})}}function histogramToCalendar(a){start_date=moment(a[0]).format("YYYY-MM-DD"),end_date=moment(a[1]).format("YYYY-MM-DD"),$("#date_fil").data("daterangepicker").setStartDate(a[0]),$("#date_fil").data("daterangepicker").setEndDate(a[1]),$("#currentDateFil").html(start_date+" - "+end_date),executeFilters()}function getAllDates(a){var b=a.histogram,c=Object.keys(b),d=c.map(function(a){return new Date(a)}),e=_.sortBy(d,function(a){return new Date(a)}),f=e.map(function(a){return moment(a).format("YYYY-M-D").toString()}),g=f.map(function(a){return{date:moment(a).format("YYYY-MM-DD"),f:b[a]}});return g}function executeFilters(){var a=areaSelect.getBounds(),b=a._southWest,c=a._northEast,d=cloudSlider,e=[];$("#imageSpinner").fadeIn("slow",function(){$("#imageSpinner").css("display","block"),$("#imageSpinner").css("z-index","1000"),$("#imageCards").fadeOut("fast")}),void 0==cloudSlider.data().from?($("#currentCloudFil").html("  0 - 100%"),d.data().from=0,d.data().to=100):$("#currentCloudFil").html("   "+d.data().from+" - "+d.data().to+"%"),$("#currentImgFil").html("  "+imageTray.toString());var f={sat:satTray.toString(),payload:imageTray.toString(),start:"2015-8-1",end:"2015-12-10",cloud:"["+d.data().from+","+d.data().to+"]",bbox:JSON.stringify([b.lng,b.lat,c.lng,c.lat]),limit:"100"};void 0!=start_date&&(e=[start_date,end_date],f.start=e[0],f.end=e[1]);$.get(main_url,f,function(a){updateMapMarkers(a),updateCards(a),updateOnImageCartCards(imageCartEntries),updateData(a)}).done(function(){$("#imageSpinner").fadeOut("slow",function(){$("#imageSpinner").css("display","none"),$("#imageSpinner").css("z-index","-1"),$("#imageCards").fadeIn("slow")})})}function updateMapMarkers(a){image_markers&&image_markers.clearLayers(),image_markers.addData(a)}function zoomToScene(a){if(a.length<2){var b=L.polygon(a[0]),c=[b.getBounds().getCenter().lng,b.getBounds().getCenter().lat];map.setView(c,8)}else{var d=L.circleMarker([a[1],a[0]]),e=[d.getLatLng().lat,d.getLatLng().lng];map.setView(e,8)}}function addImageToCart(a,b,c,d){var e={scene_id:a,image_url:b,published:c,bundlink:d};imageCartEntries.push(e);var f=imageCartEntries.length;$(".imageCartCount").text(f),$("#imagetocart_"+a).text("Remove from Cart"),$("#imagetocart_"+a).removeClass("btn-info"),$("#imagetocart_"+a).addClass("btn-warning"),$("#imagetocart_"+a).attr("onclick",'removeImageFromCart("'+a+'","'+b+'")');var g=$("#imagecart-template").html();Mustache.parse(g),rendered_imageCartEntries=Mustache.to_html(g,{imageCartEntries:imageCartEntries}),$("#image_fil_cart").html(rendered_imageCartEntries)}function removeImageFromCart(a,b,c,d){var e={scene_id:a,image_url:b,published:c,bundlink:d};removedCartEntries.push(e);var f=_.findIndex(imageCartEntries,e),g=(_.pullAt(imageCartEntries,f),imageCartEntries.length);$(".imageCartCount").text(g),$("#imagetocart_"+a).text("Add to Cart"),$("#imagetocart_"+a).removeClass("btn-warning"),$("#imagetocart_"+a).addClass("btn-info"),$("#imagetocart_"+a).attr("onclick",'addImageToCart("'+a+'","'+b+'")');var h=$("#imagecart-template").html();Mustache.parse(h),rendered_imageCartEntries=Mustache.to_html(h,{imageCartEntries:imageCartEntries}),$("#imageCartList").html(rendered_imageCartEntries)}function updateCards(a){var b=$("#card-template").html();Mustache.parse(b),data_array=a.features;var c=[];for(var d in data_array){var e={image_url:data_array[d].properties.links.thumbnail_url,payload:data_array[d].properties.payload,sat_id:data_array[d].properties.sat.sat_id,published:data_array[d].properties.published_time.split("T")[0],receiving_station:data_array[d].properties.receiving_station,scene_id:data_array[d].properties.scene_id,cloud_cover:data_array[d].properties.cloud_cover,bundlink:data_array[d].properties.links.bundle_url,zoomtoscene:JSON.stringify(data_array[d].geometry.coordinates)};c.push(e)}rendered_cards=Mustache.to_html(b,{cards:c}),$("#imageCards").html(rendered_cards)}function updateOnImageCartCards(a){for(var b in a)onClickRemoveFromCart(a[b])}function onClickRemoveFromCart(a){$("#imagetocart_"+a.scene_id).text("Remove from Cart"),$("#imagetocart_"+a.scene_id).removeClass("btn-info"),$("#imagetocart_"+a.scene_id).addClass("btn-warning"),$("#imagetocart_"+a.scene_id).attr("onclick",'removeImageFromCart("'+a.scene_id+'","'+a.image_url+'")')}function isInArray(a,b){return-1!==b.indexOf(a)}function downloadAllImages(){for(var a in imageCartEntries){var b=window.open(imageCartEntries[a].image_url,"_blank");b.focus()}}function init(){$.material.init(),cloudSlider.ionRangeSlider({type:"double",min:0,max:100,from:0,to:100,grid:!0,onFinish:function(){executeFilters()}})}function init_map(){var a="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",b='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',c=new L.TileLayer(a,{minZoom:5,maxZoom:8,attribution:b});map.setView(new L.LatLng(11.5,121.8),5),map.addLayer(c);var d,e;d=$("#map_section").width(),e=$("#map_section").height(),areaSelect=L.areaSelect({width:d-100,height:e-100,keepAspectRatio:!1}),areaSelect.addTo(map),areaSelect.on("change",function(){bounds=areaSelect.getBounds(),executeFilters(bounds)});var f={radius:8,fillColor:"#1c3166",color:"#000",weight:1,opacity:1,fillOpacity:.4},g={color:"transparent",weight:3,opacity:1,fillColor:"rgba(45, 96, 210,0.5)",fillOpacity:.5},h={closeOnClick:!0,className:"popup",closeButton:!1};image_markers=L.geoJson(!1,{style:function(a){return"Point"==a.geometry.type?f:g},pointToLayer:function(a,b){return L.circleMarker(b,f)},onEachFeature:function(a,b){var c=new L.popup(h),d="<h4>SCENE INFO</h4>";d+="<p><b>Acquisition Date:</b> "+a.properties.published+"</p>",d+="<p><b>Cloud Cover:</b> "+a.properties.cloud_cover+"</p>",d+="<p><b>Receiving Station:</b> "+a.properties.receiving_station+"</p>",d+="<p><b>Satellite:</b> "+a.properties.sat.sat_id+"</p>",d+="<p><b>Scene Name:</b> "+a.properties.scene_id+"</p>",d+="<p><b>Sensor:</b> "+a.properties.payload+"</p>",c.setContent(d),b.bindPopup(c)}}),image_markers.addTo(map)}var image_section_width=$("#image_section").width()-60,margin={top:15,right:5,bottom:25,left:20},width=image_section_width-margin.left-margin.right,height=100-margin.top-margin.bottom,x=d3.time.scale().rangeRound([0,width-margin.left-margin.right]),y=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.time.format("%b %d")).tickSize(3).tickPadding(12),yAxis=d3.svg.axis().scale(y).orient("left").ticks(6),svg=d3.select("#chart").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").attr("stroke","white").call(xAxis),svg.append("g").attr("class","y axis").attr("transform","translate(0,"+width+")").attr("stroke","white").call(yAxis);var brush=d3.svg.brush().x(x).on("brushend",brushed);svg.append("g").attr("class","x brush").call(brush).selectAll("rect").attr("y",-6).attr("height",height+7);var imageCartEntries=[],removedCartEntries=[],main_url="http://api.images.phl-microsat.xyz/scene/multi/?format=json&date_hist=day",cloudSlider=$("#cloud_slide"),map=L.map("map"),imageTray=["hpt","mfc","wfc","smi","landsat8"],satTray=["diwata-1","landsat8"],calendar_fil,start_date,end_date;$(function(){init(),init_map(),$("#satelliteFilter, #sensorFilter").on("change",function(){executeFilters()}),$(".imageFilter").on("change",function(){imageTray=[],$.each($("input[name='imgFilter']:checked"),function(){imageTray.push($(this).val())});var a=isInArray("landsat8",imageTray);satTray=a===!0&&imageTray.length>=2?["diwata-1","landsat8"]:a===!1&&imageTray.length>=1?["diwata-1"]:["landsat8"],executeFilters()}),$(".ccNoDataFilter").on("change",function(){$(".ccNoDataFilter").val();executeFilters()}),calendar_fil=$("#date_fil").daterangepicker({showDropdowns:!0,autoApply:!0,linkedCalendars:!1,startDate:"01/1/2015",endDate:"12/31/2015",drops:"up"},function(a,b,c){$("#currentDateFil").html(a.format("YYYY-MM-DD")+" - "+b.format("YYYY-MM-DD")),start_date=a.format("YYYY-MM-DD"),end_date=b.format("YYYY-MM-DD"),executeFilters()}),executeFilters()}),$("#moreFilterShow,#imageShoppingCart").on("click",function(){var a=$("#cloud_image").css("display");"none"==a&&($("#mainFilterCon").animate({height:["500px","swing"]},750,"swing"),$("#cloud_image").fadeIn("slow"))}),$("#filterCloseButton").on("click",function(){$("#mainFilterCon").animate({height:["0px","swing"]},750,"swing"),$("#cloud_image").fadeOut("slow")}),$("#imageCards").perfectScrollbar({maxScrollbarLength:100}),$("#image_fil_cart").perfectScrollbar({maxScrollbarLength:100}),$("#imagecartBtn,#cart_fil").on("click",function(){$("#cloud_fil, #image_fil,#date_fil_container").css("display","none"),$("#image_fil_cart").css("display","block"),$("#imagecartBtn").addClass("filter-tab-active"),$("#filtersBtn").removeClass("filter-tab-active")}),$("#filtersBtn,#filter_icon").on("click",function(){$("#cloud_fil, #image_fil,#date_fil_container").css("display","block"),$("#image_fil_cart").css("display","none"),$("#imagecartBtn").removeClass("filter-tab-active"),$("#filtersBtn").addClass("filter-tab-active")});