function createHistogram(a){var b=$("#image_section").width()-60,c=(d3.format(""),d3.time.format("%m").parse,d3.time.format("%m/%y"),{top:15,right:5,bottom:25,left:20}),d=b-c.left-c.right,e=100-c.top-c.bottom,f=d3.time.scale().range([0,d]),g=d3.scale.linear().range([e,0]),h=d3.svg.axis().scale(g).orient("left").ticks(6),i=d3.select("#chart").append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),f=d3.scale.linear().domain([1,12]).rangeRound([0,d]),g=d3.scale.linear().domain([0,d3.max(a,function(a){return a.count})]).range([e,0]),j=d3.svg.axis().scale(f).orient("bottom"),k=i.selectAll(".bar").data(a).enter().append("g").attr("class","bar").attr("transform",function(b){var c=f(b.month)-.5*(.5*d/a.length);return"translate("+c+","+g(b.count)+")"});k.append("rect").attr("x",function(a,b){return 0*b}).attr("width",.5*d/a.length).attr("height",function(a){return e-g(a.count)}),i.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+e+")").attr("stroke","white").call(j),i.append("g").attr("class","axis axis--y").attr("transform","translate(0,"+d+")").attr("stroke","white").call(h)}function executeFilters(){var a=areaSelect.getBounds(),b=a._southWest,c=a._northEast,d=cloudSlider,e=[];void 0==cloudSlider.data().from?($("#currentCloudFil").html("  0 - 100%"),d.data().from=0,d.data().to=100):$("#currentCloudFil").html("   "+d.data().from+" - "+d.data().to+"%"),$("#currentImgFil").html("  "+imageTray.toString());var f={sat:satTray.toString(),payload:imageTray.toString(),start:"2015-8-1",end:"2015-12-10",cloud:"["+d.data().from+","+d.data().to+"]",bbox:JSON.stringify([b.lng,b.lat,c.lng,c.lat]),limit:"100"};void 0!=start_date&&(e=[start_date,end_date],f.start=e[0],f.end=e[1]),$.get(main_url,f,function(a){console.log(a),updateMapMarkers(a),updateCards(a),updateOnImageCartCards(imageCartEntries)})}function updateMapMarkers(a){image_markers&&image_markers.clearLayers(),image_markers.addData(a)}function zoomToScene(a){if(a.length<2){var b=L.polygon(a[0]),c=[b.getBounds().getCenter().lng,b.getBounds().getCenter().lat];map.setView(c,8)}else{var d=L.circleMarker([a[1],a[0]]),e=[d.getLatLng().lat,d.getLatLng().lng];map.setView(e,8)}}function addImageToCart(a,b,c,d){var e={scene_id:a,image_url:b,published:c,bundlink:d};imageCartEntries.push(e);var f=imageCartEntries.length;$(".imageCartCount").text(f),$("#imagetocart_"+a).text("Remove from Cart"),$("#imagetocart_"+a).removeClass("btn-info"),$("#imagetocart_"+a).addClass("btn-warning"),$("#imagetocart_"+a).attr("onclick",'removeImageFromCart("'+a+'","'+b+'")');var g=$("#imagecart-template").html();Mustache.parse(g),rendered_imageCartEntries=Mustache.to_html(g,{imageCartEntries:imageCartEntries}),$("#image_fil_cart").html(rendered_imageCartEntries)}function removeImageFromCart(a,b,c,d){var e={scene_id:a,image_url:b,published:c,bundlink:d};removedCartEntries.push(e);var f=_.findIndex(imageCartEntries,e),g=(_.pullAt(imageCartEntries,f),imageCartEntries.length);$(".imageCartCount").text(g),$("#imagetocart_"+a).text("Add to Cart"),$("#imagetocart_"+a).removeClass("btn-warning"),$("#imagetocart_"+a).addClass("btn-info"),$("#imagetocart_"+a).attr("onclick",'addImageToCart("'+a+'","'+b+'")');var h=$("#imagecart-template").html();Mustache.parse(h),rendered_imageCartEntries=Mustache.to_html(h,{imageCartEntries:imageCartEntries}),$("#imageCartList").html(rendered_imageCartEntries)}function updateCards(a){var b=$("#card-template").html();Mustache.parse(b),data_array=a.features;var c=[];for(var d in data_array){var e={image_url:data_array[d].properties.links.thumbnail_url,payload:data_array[d].properties.payload,sat_id:data_array[d].properties.sat.sat_id,published:data_array[d].properties.published_time,receiving_station:data_array[d].properties.receiving_station,scene_id:data_array[d].properties.scene_id,cloud_cover:data_array[d].properties.cloud_cover,bundlink:data_array[d].properties.links.bundle_url,zoomtoscene:JSON.stringify(data_array[d].geometry.coordinates)};c.push(e)}rendered_cards=Mustache.to_html(b,{cards:c}),$("#imageCards").html(rendered_cards)}function updateOnImageCartCards(a){for(var b in a)onClickRemoveFromCart(a[b])}function onClickRemoveFromCart(a){$("#imagetocart_"+a.scene_id).text("Remove from Cart"),$("#imagetocart_"+a.scene_id).removeClass("btn-info"),$("#imagetocart_"+a.scene_id).addClass("btn-warning"),$("#imagetocart_"+a.scene_id).attr("onclick",'removeImageFromCart("'+a.scene_id+'","'+a.image_url+'")')}function isInArray(a,b){return-1!==b.indexOf(a)}function downloadAllImages(){for(var a in imageCartEntries){var b=window.open(imageCartEntries[a].image_url,"_blank");b.focus()}}function dateHistogramData(a){var b=a.features,c=[],d=[];for(var e in b){var f=b[e].properties.published_time,g=f.split("T")[0].split("-");c.push(parseInt(g[1]))}for(var e=1;13>e;e++)d.push({month:e,count:0});for(var e=0;e<c.length;e++)d[c[e]-1].month==c[e]&&d[c[e]-1].count++;return d}function countAvailableDates(a){createHistogram(a)}function updateCalendarFilter(a){data_array=a.features,start_date=data_array[0].properties.published_time.split("T")[0],end_date=data_array[data_array.length-1].properties.published_time.split("T")[0],$("#currentDateFil").html(start_date+" - "+end_date)}function init(){$.material.init(),cloudSlider.ionRangeSlider({type:"double",min:0,max:100,from:0,to:100,grid:!0})}function init_map(){var a="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",b='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',c=new L.TileLayer(a,{minZoom:5,maxZoom:8,attribution:b});map.setView(new L.LatLng(11.5,121.8),5),map.addLayer(c);var d,e;d=$("#map_section").width(),e=$("#map_section").height(),areaSelect=L.areaSelect({width:d-100,height:e-100,keepAspectRatio:!1}),areaSelect.addTo(map),areaSelect.on("change",function(){bounds=areaSelect.getBounds(),executeFilters(bounds)});var f={radius:8,fillColor:"#1c3166",color:"#000",weight:1,opacity:1,fillOpacity:.4},g={color:"#2956bd",weight:3,opacity:1,fillColor:"rgba(45, 96, 210,0.5)",fillOpacity:.3},h={closeOnClick:!0,className:"popup",closeButton:!1};image_markers=L.geoJson(!1,{style:function(a){return"Point"==a.geometry.type?f:g},pointToLayer:function(a,b){return L.circleMarker(b,f)},onEachFeature:function(a,b){var c=new L.popup(h),d="<h4>SCENE INFO</h4>";d+="<p><b>Acquisition Date:</b> "+a.properties.published+"</p>",d+="<p><b>Cloud Cover:</b> "+a.properties.cloud_cover+"</p>",d+="<p><b>Receiving Station:</b> "+a.properties.receiving_station+"</p>",d+="<p><b>Satellite:</b> "+a.properties.sat.sat_id+"</p>",d+="<p><b>Scene Name:</b> "+a.properties.scene_id+"</p>",d+="<p><b>Sensor:</b> "+a.properties.payload+"</p>",c.setContent(d),b.bindPopup(c)}}),image_markers.addTo(map)}var imageCartEntries=[],removedCartEntries=[],main_url="http://api.images.phl-microsat.xyz/scene/multi/?format=json",cloudSlider=$("#cloud_slide"),map=L.map("map"),imageTray=["hpt","mfc","wfc","smi","landsat8"],satTray=["diwata-1","landsat8"],calendar_fil,start_date,end_date;$(function(){init(),init_map(),$("#satelliteFilter, #sensorFilter").on("change",function(){executeFilters()}),$(".imageFilter").on("change",function(){imageTray=[],$.each($("input[name='imgFilter']:checked"),function(){imageTray.push($(this).val())});var a=isInArray("landsat8",imageTray);satTray=a===!0&&imageTray.length>=2?["diwata-1","landsat8"]:a===!1&&imageTray.length>=1?["diwata-1"]:["landsat8"],executeFilters()}),cloudSlider.on("change",function(){executeFilters()}),calendar_fil=$("#date_fil").daterangepicker({showDropdowns:!0,autoApply:!0,linkedCalendars:!1,startDate:"01/1/2015",endDate:"12/31/2015",drops:"up"},function(a,b,c){$("#currentDateFil").html(a.format("YYYY-MM-DD")+" - "+b.format("YYYY-MM-DD")),start_date=a.format("YYYY-MM-DD"),end_date=b.format("YYYY-MM-DD"),executeFilters()}),executeFilters()}),$("#moreFilterShow,#imageShoppingCart").on("click",function(){var a=$("#cloud_image").css("display");$("#filtersBtn").hasClass("filter-tab-active");"none"==a&&$("#cloud_image").slideToggle("fast")}),$("#filterCloseButton").on("click",function(){$("#cloud_image").slideToggle("fast")}),$("#imageCards").perfectScrollbar({maxScrollbarLength:100}),$("#image_fil_cart").perfectScrollbar({maxScrollbarLength:70}),$("#imagecartBtn,#cart_fil").on("click",function(){$("#cloud_fil, #image_fil,#date_fil_container").css("display","none"),$("#image_fil_cart").css("display","block"),$("#imagecartBtn").addClass("filter-tab-active"),$("#filtersBtn").removeClass("filter-tab-active")}),$("#filtersBtn,#filter_icon").on("click",function(){$("#cloud_fil, #image_fil,#date_fil_container").css("display","block"),$("#image_fil_cart").css("display","none"),$("#imagecartBtn").removeClass("filter-tab-active"),$("#filtersBtn").addClass("filter-tab-active")});